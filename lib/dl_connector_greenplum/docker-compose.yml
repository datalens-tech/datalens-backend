services:
  # yes, greenplum tests run on a postgres db
  db-postgres-13:
    build:
      context: docker-compose
      dockerfile: Dockerfile.db-postgres-13
    environment:
      POSTGRES_DB: "test_data"
      POSTGRES_USER: "datalens"
      POSTGRES_PASSWORD: "qwerty"
    ports:
     - "52302:5432"

  db-greenplum-6:
    build:
      context: docker-compose
      dockerfile: Dockerfile.db-greenplum-6
    environment:
      GREENPLUM_PASSWORD: "qwerty"
      GREENPLUM_DATABASE_NAME: "test_data"
    ports:
     - "52320:5432"
    healthcheck:
      test: ["CMD-SHELL", "psql -U gpadmin -d test_data -c 'SELECT 1'"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 90s

  db-greenplum-7:
    build:
      context: docker-compose
      dockerfile: Dockerfile.db-greenplum-7
    environment:
      GREENPLUM_PASSWORD: "qwerty"
      GREENPLUM_DATABASE_NAME: "test_data"
    ports:
     - "52321:5432"
    healthcheck:
      test: ["CMD-SHELL", "psql -U gpadmin -d test_data -c 'SELECT 1'"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 90s

  # INFRA
  pg-us:
    extends:
      file: ../testenv-common/docker-compose.common.yml
      service: pg-us
    ports:
     - "52310:5432"

  us:
    extends:
      file: ../testenv-common/docker-compose.common.yml
      service: us
    ports:
     - "52311:8080"

  redis-caches:
    # image: "bitnami/redis:5.0.8"
    image: "bitnami/redis:5.0.8@sha256:3127620da977815556439a9dc347fff89432a79b6bb6e93a16f20ac4a34ce337"
    environment:
      ALLOW_EMPTY_PASSWORD: "yes"
    ports:
     - "52312:6379"
