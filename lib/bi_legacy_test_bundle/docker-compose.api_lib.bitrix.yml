version: '3.7'

x-constants:
  US_MASTER_TOKEN: &c-us-master-token "AC1ofiek8coB"
  PG_PASSWORD: &c-pg-password "qwerty"
  REDIS_PASSWORD: &c-redis-password "AwockEuvavDyinmeakmiRiopanbesBepsensUrdIz5"


services:
  redis:
    # image: "bitnami/redis:5.0.8"
    # also used for mutation cache
    image: "registry.yandex.net/statinfra/redis@sha256:3127620da977815556439a9dc347fff89432a79b6bb6e93a16f20ac4a34ce337"
    environment:
      REDIS_PASSWORD: *c-redis-password
    ports:
      - 50504:6379

  init-db:
    build:
      context: docker-compose-api-lib
      dockerfile: Dockerfile.init-db
    environment:
      WAIT_FOR_MSSQL: 0
      WAIT_FOR_ORACLE: 0
    ports:
      - 50508:8000

  db-postgres:
    build:
      context: docker-compose-api-lib
      dockerfile: Dockerfile.db-postgres
    environment:
      POSTGRES_DB: datalens
      POSTGRES_USER: datalens
      POSTGRES_PASSWORD: *c-pg-password
    ports:
      - 50513:5432

  pg-us:
    build:
      context: ../../mainrepo/lib/testenv-common/images
      dockerfile: Dockerfile.pg-us
    environment:
      POSTGRES_DB: us-db-ci_purgeable
      POSTGRES_USER: us
      POSTGRES_PASSWORD: us
    ports:
      - 50509:5432

  us:
    build:
      context: ../testenv_common_private/images
      dockerfile: Dockerfile.us-single-tenant
    ports:
      - 50500:80
    depends_on:
      - pg-us
    environment:
      POSTGRES_DSN_LIST: "postgres://us:us@pg-us:5432/us-db-ci_purgeable"
      AUTH_POLICY: "required"
      DLS_ENABLED: "false"
      DISABLE_DLS: "true"
      MASTER_TOKEN: *c-us-master-token
