## Patch DLS by user map

Скрипт для проведения DLS'ных миграций. Изначально задумывался для помощи с миграцией организаций на федеративные учетки.

Скрипт принимает на вход маппинг из старых пользователей в новые и перевешивает права в DLS согласно этому маппингу.

Команда запуска:
` [PYTHONWARNINGS="ignore:Unverified HTTPS request" US_MASTER_TOKEN=... US_HOST=...] DLS_API_KEY=... DLS_HOST=... python3 patch_dls_by_user_map.py --user-map map --nodes-source source --comment comment [--remove-old-permissions --dry-run]`

Параметры:

- `--user-map` - путь к локальному файлу с маппингом. Каждая строчка файла должна быть в формате `old_user new_user`. Префикс `user:` перед id пользователя разрешается опустить.
- `--nodes-source` - либо путь к локальному файлу со списком нод для миграции, либо id тенанта, из которого нужно взять все возможные ноды. В первом случае каждый id должен быть в отдельной строке. Во втором случае нужно заполнить US'ные переменные окружения (`US_MASTER_TOKEN` и `US_HOST`)
- `--comment` - комментарий к диффу в DLS (например, номер тикета с миграцией)
- `--remove-old-permissions` - по умолчанию старые права не удаляются, а только добавляются права для новых пользователей. Если выставить этот флаг, то также произойтет отзыв прав у старых
- `--dry-run` - не применять изменения, а только залогировать дифф
- `--verbose` - писать информацию о пропущенных нодах

Переменные окружения:

- `PYTHONWARNINGS="ignore:Unverified HTTPS request"` - гасит warning на `verify=False` при запросах
- `US_MASTER_TOKEN` - токен для US. Можно взять из https://yav.yandex-team.ru/secret/sec-01csc2x33km5dc7x8p51hfh0nj/explore/versions для нужного окружения
- `US_HOST` - хост US для нужного окружения
- `DLS_API_KEY` - токе для DLS. Можно взять из секретов вида datalens-creds-* для нужного окружения
- `DLS_HOST` - хост DLS для нужного окружения
