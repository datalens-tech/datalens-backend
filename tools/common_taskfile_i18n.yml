version: '3'

vars:
  PACKAGE_NAME:
    sh: basename {{.USER_WORKING_DIR}}

tasks:
  update-po:
    deps:
    dir: ../docker_build
    cmds:
      - ./run-project-bake update-po
        --set update-po.args.PACKAGE_NAME={{.PACKAGE_NAME}}
        --set update-po.contexts.src={{.USER_WORKING_DIR}}
        --set update-po.output="type=local,dest={{.USER_WORKING_DIR}}/{{.PACKAGE_NAME}}"
        --progress=plain
        || true

  msgfmt:
    dir: ../docker_build
    cmds:
      - ./run-project-bake msgfmt
        --set msgfmt.args.PACKAGE_NAME={{.PACKAGE_NAME}}
        --set msgfmt.contexts.src={{.USER_WORKING_DIR}}
        --set msgfmt.output="type=local,dest={{.USER_WORKING_DIR}}/{{.PACKAGE_NAME}}"
        --progress=plain
        || true

  _gen-formula-ref-locale:
    dir: ../docker_build
    vars:
      OUTPUT_DIR: "../artifacts/doc_formula_ref"
    cmds:
      - ./run-project-bake gen-formula-ref
        --set gen-formula-ref.args.LOCALE_NAME={{.LOCALE_NAME}}
        --set gen-formula-ref.args.OUTPUT_DIR={{.OUTPUT_DIR}}
        --set gen-formula-ref.args.CONFIG_VERSION={{.CONFIG_VERSION}}
        --set gen-formula-ref.output="type=local,dest={{.OUTPUT_DIR}}/{{.LOCALE_NAME}}"
        --progress=plain
        || true

  gen-formula-ref:
    # `task i18n:gen-formula-ref -- <doc_config_version>`
    # Generates docs for all locales in <repo_root>/artifacts/generated_docs
    # FIXME: Generate only supported locales (listed in formula_ref config)
    vars:
      CONFIG_VERSION: "{{.CLI_ARGS}}"
    deps:
      - {task: "_gen-formula-ref-locale", vars: {LOCALE_NAME: "en", CONFIG_VERSION: "{{.CONFIG_VERSION}}"}}
      - {task: "_gen-formula-ref-locale", vars: {LOCALE_NAME: "ru", CONFIG_VERSION: "{{.CONFIG_VERSION}}"}}
