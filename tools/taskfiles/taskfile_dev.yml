version: '3'

silent: true

tasks:
  init:
    desc: Initialize project
    cmds:
      - echo "Cleaning unused envs in {{.VENV_PATH}}"
      - for env in "$UNUSED_ENVS"; do
          echo "Removing $env";
          poetry env remove $env --directory={{.PYPROJECT_TOML_PATH}};
        done;
      - echo "Initializing python virtual environment in {{.VENV_PATH}}"
      - poetry install --directory={{.PYPROJECT_TOML_PATH}} --sync --no-root
    requires:
      vars:
        - PYPROJECT_TOML_PATH
    vars:
      UNUSED_ENVS:
        sh: poetry env list --no-ansi --directory={{.PYPROJECT_TOML_PATH}} 
          | sed 's/ (Activated)//g'
          | grep -v \".venv\"

  poetry_lock:
    desc: Lock dependencies in metapkg
    cmds:
      - poetry lock --no-update --directory={{.PYPROJECT_TOML_PATH}}
    requires:
      vars:
        - PYPROJECT_TOML_PATH
  
  _venv_bin:
    desc: Run venv bin
    dir: "{{.USER_WORKING_DIR}}"
    cmds:
      - 'PATH="{{.VENV_PATH}}/bin:$PATH" {{.VENV_PATH}}/bin/{{.COMMAND}} {{.CLI_ARGS}}'
    requires:
      vars:
        - VENV_PATH
        - COMMAND

  venv_run:
    desc: Run poetry command
    dir: "{{.USER_WORKING_DIR}}"
    cmds:
      - task: _venv_bin
        vars:
          COMMAND: "python -m {{.COMMAND}}"
          CLI_ARGS: "{{.CLI_ARGS}}"

  clean:
    desc: Clean project
    cmds:
      - echo "Cleaning python virtual environment"
      - rm -rf {{.VENV_PATH}}
    requires:
      vars:
        - VENV_PATH

  lint:
    desc: Lint code
    dir: "{{.USER_WORKING_DIR}}"
    cmds:
      - echo "Running toml-sort checks..."
      - task: _venv_bin
        vars:
          COMMAND: "toml-sort --check {{.TOML_FILES}}"

      - echo "Running black checks..."
      - task: venv_run
        vars:
          COMMAND: "black --config {{.LINTERS_PYPROJECT_TOML_PATH}} --check {{.LINT_PATH}}"
      
      - echo "Running isort checks..."
      - task: venv_run
        vars:
          COMMAND: "isort --settings-path {{.LINTERS_PYPROJECT_TOML_PATH}} --check-only {{.LINT_PATH}}"
      
      - echo "Running ruff checks..."
      - task: venv_run
        vars:
          COMMAND: "ruff check {{.LINT_PATH}}"
    vars:
      LINT_PATH: '{{.CLI_ARGS | default "."}}'
      TOML_FILES:
        sh: find {{.CLI_ARGS | default "."}} -name '*.toml' | tr '\n' ' '
  
  lint-fix:
    desc: Lint fix code
    dir: "{{.USER_WORKING_DIR}}"
    cmds:
      - echo "Running toml-sort fixes..."
      - task: _venv_bin
        vars:
          COMMAND: "toml-sort --in-place {{.TOML_FILES}}"

      - echo "Running black fixes..."
      - task: venv_run
        vars:
          COMMAND: "black --safe --config {{.LINTERS_PYPROJECT_TOML_PATH}} {{.LINT_PATH}}"
      
      - echo "Running isort fixes..."
      - task: venv_run
        vars:
          COMMAND: "isort --settings-path {{.LINTERS_PYPROJECT_TOML_PATH}} {{.LINT_PATH}}"

      - echo "Running ruff fixes..."
      - task: venv_run
        vars:
          COMMAND: "ruff check --fix {{.LINT_PATH}}"
    vars:
      LINT_PATH: '{{.CLI_ARGS | default "."}}'
      TOML_FILES:
        sh: find {{.CLI_ARGS | default "."}} -name '*.toml' | tr '\n' ' '

  test:
    desc: Run tests
    cmds:
      - task: venv_run
        vars:
          COMMAND: pytest
          CLI_ARGS: "{{.CLI_ARGS}}"
    vars:
      CLI_ARGS: '{{.CLI_ARGS | default "."}}'

  compose_start:
    desc: Start docker-compose
    dir: "{{.USER_WORKING_DIR}}"
    cmds:
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} up {{if .DETACH}}-d{{end}}
    vars:
      DETACH: '{{.DETACH | default true }}'
      DOCKER_COMPOSE_FILE: '{{.DOCKER_COMPOSE_FILE | default "docker-compose.yml"}}'

  compose_stop:
    desc: Stop docker-compose
    dir: "{{.USER_WORKING_DIR}}"
    cmds:
      - docker-compose -f {{.DOCKER_COMPOSE_FILE}} down
    vars:
      DOCKER_COMPOSE_FILE: '{{.DOCKER_COMPOSE_FILE | default "docker-compose.yml"}}'

  compose_stop_all:
    desc: Stop and remove all docker containers
    cmds:
      - docker stop $(docker ps -a -q)

  ssh_forward_start:
    desc: Forward docker ports to localhost
    requires:
      vars:
        - HOST
    cmds:
      - for port in $PORTS; do
          echo "Forwarding port $port";
          ssh -f -N -L $port:localhost:$port {{.HOST}};
        done;
        wait
    var:
    env:
      PORTS:
        sh: DOCKER_HOST=ssh://{{.HOST}} docker ps --format "{{`{{.Ports}}`}}" 
          | grep -o ':[0-9]*->' 
          | sed 's/->//g'
          | sed 's/://g' 
          | uniq
  
  ssh_forward_stop:
    desc: Stop SSH port forwarding for Docker containers
    cmds:
      - echo "Next processes will be killed:"
      - ps -ef | grep "ssh -f -N -L" | grep --invert-match "grep"
      - pkill -f "ssh -f -N -L"
