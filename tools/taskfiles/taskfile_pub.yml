version: '3'

tasks:
  validate-dotenv:
    dir: .
    dotenv: [ "./.env" ]
    cmds:
      - "[ -z $PUB_SYNC_TARGET_REPO_DIR ]  # Should be set in particular task. Not in .env"
      - "[ ! -z $PUB_SYNC_TARGET_REPO_DIR_PREPUBLIC ]"
      - "[ ! -z $PUB_SYNC_TARGET_REPO_DIR_PUBLIC ]"
      - "gh --version  # Check that GitHub CLI is installed"

  prepublic-file-sync:
    deps: [ validate-dotenv ]
    dir: .
    dotenv: [ "./.env" ]
    env:
      STRICT_MODE: "0"
    cmds:
      # Did not find a way to substitute env var in `env` section with value from .env file
      #  So we substitute it in shell...
      - PUB_SYNC_TARGET_REPO_DIR=${PUB_SYNC_TARGET_REPO_DIR_PREPUBLIC} bash "public_repo_sync/run_files_sync.bash"

  public-file-sync:
    deps: [ validate-dotenv ]
    dir: .
    dotenv: [ "./.env" ]
    env:
      STRICT_MODE: "1"
      DEST_TARGET_BRANCH: "main"
    cmds:
      # Did not find a way to substitute env var in `env` section with value from .env file
      #  So we substitute it in shell...
      - PUB_SYNC_TARGET_REPO_DIR=${PUB_SYNC_TARGET_REPO_DIR_PUBLIC} bash "public_repo_sync/run_files_sync.bash"

  sync-pub-metapkg:
    dir: ..
    dotenv:
      - "./ops/ci/.env"  # FIXME: Use single dotenv in /tools
    cmds:
      - source $HOST_VENV_ROOT/bin/activate &&
        scoped-metapkg-sync
        --orig-metapkg-path ./ops/ci
        --scoped-metapkg-path ./mainrepo/metapkg
        --remove-private-pypi
        ../lib

  dump-cleanup-mainrepo-dir-to-custom-dir:
    dir: .
    cmd: bash public_repo_sync/dump_main_repo_with_cleanup.bash
