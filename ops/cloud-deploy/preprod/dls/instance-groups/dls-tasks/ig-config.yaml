name: dls-tasks
service_account_id: bfbdtpfu9qlotm99j4h6
scale_policy:
  fixed_scale:
    size: 1
deploy_policy:
  max_unavailable: 1
  # здесь лучше 0, для того чтобы виртуалки не пересоздавались каждый раз
  max_expansion: 0
allocation_policy:
  zones:
  - zone_id: ru-central1-a
  - zone_id: ru-central1-b
  - zone_id: ru-central1-c
platform_l7_load_balancer_spec:
  preferred_ip_version: IPV6
  target_group_spec:
    # название вашей таргет-группы, это специальная тг для L7, из интерфейса ее создать невозможно
    name: datalens-preprod-dls-tasks
instance_template:
  # шаблон для имени вм, мы используем такой app_name-{instance.internal_dc}-{instance.index}
  name: dls-tasks-{instance.internal_dc}-{instance.index}
  fqdn: dls-tasks-{instance.internal_dc}-{instance.index}.{instance.internal_dc}.datalens.cloud-preprod.yandex.net
  service_account_id: bfbu9gprqdutnf1g7t1h
  labels:
    yandex-dns: ig
    conductor-group: datalens-back-preprod
    conductor-role: dls-tasks
  platform_id: standard-v2
  resources_spec:
    memory: 2G
    cores: 2
    core_fraction: 20
  boot_disk_spec:
    mode: READ_WRITE
    disk_spec:
      # айдишник образа, созданного packer-ом, подставляется тимсити, здесь не менять
      image_id: __IMAGE_ID__
      type_id: network-ssd
      size: 10g
  # логи пишутся на secondary-disk, чтобы избежать потери при деплое
  secondary_disk_specs:
  - mode: READ_WRITE
    device_name: data
    disk_spec:
      type_id: network-ssd
      size: 11g
  network_interface_specs:
  - network_id: c64m78s133l6m4emf6t0
    primary_v6_address_spec: {}
    primary_v4_address_spec: {}
    security_group_ids:
    - c64rh4ff79f3f12097ft
  metadata:
    k8s-runtime-bootstrap-yaml: ' '
    # настройка записи логов на secondary-disk
    user-data: |
      #cloud-config
      fs_setup:
      - device: /dev/disk/by-id/virtio-data
        filesystem: ext4
        partition: auto
        overwrite: false
      mounts:
      - [/dev/disk/by-id/virtio-data, /data, ext4, 'defaults,errors=remount-ro', '0', '2']
      - [/data/log/fluent, /var/log/fluent, none, 'defaults,bind', '0', '0']
      runcmd:
      - mkdir -p /data/log/fluent
      - chmod 0777 /data
      - chown td-agent:td-agent /data/log/fluent
      - chmod 0755 /data/log/fluent
      - mount --make-rprivate /data
      - mount -o bind /data/log/fluent /var/log/fluent
      - /usr/local/bin/update_env_vars
      - /usr/bin/skm decrypt
      - /usr/local/bin/update_secrets
      env_vars:
        DLS_DAEMON_NAME: tasks
        DLS_ENV: ext_testing
        YENV_TYPE: testing
    osquery_tag: ycloud-svc-datalens-bi
    shortname: dls-tasks-{instance.internal_dc}-{instance.index}.{instance.internal_dc}
    nsdomain: datalens.cloud-preprod.yandex.net
    skm: |
      api_endpoint: api.cloud-preprod.yandex.net:443
      skip_tls_verify: false
      kms_private_endpoint: ""
      iam_private_endpoint: ""
      kms_private_skip_tls_verify: false
      kms_key_uri: yc-kms://e10mng38moenmrvomcdo
      encrypted_dek: AAAAAQAAABRlMTA5bGE2aGswNXI5NnNhOWhmZAAAABBorYDYeoteUPpo3XUax0XsAAAADOJ+epeMRd48mJjR/Nt4Z5oBBRtzLM2k/RM3DG9jIxX0+kwmIfffKGksyT3Qh8yEi2wIsRFx+7XEzUZvvyd3bzM0D22hhRKRfWuq7cYh4l3DlI7rDd3KcHgaKXJS
      secrets:
        - path: /etc/secrets/TVM_SECRET
          ciphertext: !!binary h7KWOPz0knebgG+w++0NWTcU75tUFH2NJ3q6uzf3z/0iqL70AHo=
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/TVM_INFO
          ciphertext: !!binary |
              zRJOSk02bP34lwkduZxM093QX+Nsv5UtXyjDpJkPuB3IRfCjAajb/Sys3eciDx/J04IPMk
              RSq+oP4g==
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/DLS_API_KEY
          ciphertext: !!binary |
              /Rs8EujW15GDmx0LMtQ5Vr7RukALvBrXg5JPAKS10es21oVueRkk87cq+W6aYLf5sLKhl3
              eOQIva9Ov1pdzSiMQSRPhqj5yh84p2jdXFug==
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/DLS_DB_PASSWORD
          ciphertext: !!binary rEItI+y5+7EMAG1vxPGu7PLp+iPlPS4PXx3XwyFDF6QF/XZWLL2nfA==
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/DLS_SENTRY_DSN
          ciphertext: !!binary |
              sc3+GYe/+0ju6aB7rOP8VEneHxFs1494Gw58IU8/KS30tiDJ9fWmb5ClujwLcDQaqzLATr
              mhJ4jDQjl0kzPuV9MKfJaJmyY3PEmOK6oGs4vjGDz4KljAgb5LhrTa2WSgdvr2ws5hnbVv
              PJPJuIOHlgRijridons8
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/LOGCH_PASSWORD
          ciphertext: !!binary j4Qd+XmUEyfAenNOT7LZz9hY8ntPXniYTLnZeFtUXJVpavlwfE2R8MNz
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/metricsagent/SOLOMON_AUTH
          ciphertext: !!binary |
              YiQcPPcS92DfkZQek5HM7SSmiS+7NhYXiwTeJkxuVkQn/1Ss1XCs5x6xUnjpGCpLMHc61X
              n2mw==
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/DLS_SOLOMON_OAUTH
          ciphertext: !!binary |
              YiQcPPcS92DfkZQek5HM7SSmiS+7NhYXiwTeJkxuVkQn/1Ss1XCs5x6xUnjpGCpLMHc61X
              n2mw==
          mode: 0
          uid: 0
          gid: 0
      enc_mode: DETERMINISTIC
      force: false
