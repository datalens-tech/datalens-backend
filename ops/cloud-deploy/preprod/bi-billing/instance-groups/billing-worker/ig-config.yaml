name: billing-worker
service_account_id: bfbdtpfu9qlotm99j4h6
scale_policy:
  fixed_scale:
    size: 1
deploy_policy:
  max_unavailable: 1
  # здесь лучше 0, для того чтобы виртуалки не пересоздавались каждый раз
  max_expansion: 0
allocation_policy:
  zones:
  - zone_id: ru-central1-a
  - zone_id: ru-central1-b
  - zone_id: ru-central1-c
platform_l7_load_balancer_spec:
  preferred_ip_version: IPV6
  target_group_spec:
    # название вашей таргет-группы, это специальная тг для L7, из интерфейса ее создать невозможно
    name: datalens-preprod-billing-worker
instance_template:
  # шаблон для имени вм, мы используем такой app_name-{instance.internal_dc}-{instance.index}
  name: billing-worker-{instance.internal_dc}-{instance.index}
  fqdn: billing-worker-{instance.internal_dc}-{instance.index}.{instance.internal_dc}.datalens.cloud-preprod.yandex.net
  service_account_id: bfbk1j9tmltib6dttc71
  labels:
    yandex-dns: ig
    conductor-group: datalens-back-preprod
    conductor-role: billing-worker
  platform_id: standard-v2
  resources_spec:
    memory: 2G
    cores: 2
    core_fraction: 20
  boot_disk_spec:
    mode: READ_WRITE
    disk_spec:
      # айдишник образа, созданного packer-ом, подставляется тимсити, здесь не менять
      image_id: __IMAGE_ID__
      type_id: network-ssd
      size: 10g
  # логи пишутся на secondary-disk, чтобы избежать потери при деплое
  secondary_disk_specs:
  - mode: READ_WRITE
    device_name: data
    disk_spec:
      type_id: network-ssd
      size: 11g
  network_interface_specs:
  - network_id: c64an5jmjnpgiaclqg8k
    primary_v6_address_spec: {}
    primary_v4_address_spec: {}
    security_group_ids:
    - c64ud7769sqduk0c71ik
  metadata:
    k8s-runtime-bootstrap-yaml: ' '
    # настройка записи логов на secondary-disk
    user-data: |
      #cloud-config
      fs_setup:
      - device: /dev/disk/by-id/virtio-data
        filesystem: ext4
        partition: auto
        overwrite: false
      mounts:
      - [/dev/disk/by-id/virtio-data, /data, ext4, 'defaults,errors=remount-ro', '0', '2']
      - [/data/log/fluent, /var/log/fluent, none, 'defaults,bind', '0', '0']
      runcmd:
      - mkdir -p /data/log/fluent
      - chmod 0777 /data
      - chown td-agent:td-agent /data/log/fluent
      - chmod 0755 /data/log/fluent
      - mount --make-rprivate /data
      - mount -o bind /data/log/fluent /var/log/fluent
      - /usr/local/bin/update_env_vars
      - /usr/bin/skm decrypt
      - /usr/local/bin/update_secrets
      env_vars:
        DL_CRY_ACTUAL_KEY_ID: cloud_preprod_2
        DL_CRY_FALLBACK_KEY_ID: 0
        RUN_CELERY: 1
        YENV_NAME: other
        YENV_TYPE: testing
        RUN_PURCHASES_AVAILABLE_CHECK: 1
    osquery_tag: ycloud-svc-datalens-bi
    shortname: billing-worker-{instance.internal_dc}-{instance.index}.{instance.internal_dc}
    nsdomain: datalens.cloud-preprod.yandex.net
    skm: |
      api_endpoint: api.cloud-preprod.yandex.net:443
      skip_tls_verify: false
      kms_private_endpoint: ""
      iam_private_endpoint: ""
      kms_private_skip_tls_verify: false
      kms_key_uri: yc-kms://e10mng38moenmrvomcdo
      encrypted_dek: AAAAAQAAABRlMTA5bGE2aGswNXI5NnNhOWhmZAAAABDoRvJ7kYnIcFezFcUK0z7lAAAADCcmdUz/s+4qHvLeqfaOfWIrFSMGbu5nfkJZpNZxs33U43AGpp2TadA5NDdh1YWXEST7UGuIoc86xmq8Xg3jvT5ES78EfoDs2TXosiAbmb+MuWDIeS8FEmHt7XmT
      secrets:
        - path: /etc/secrets/TVM_SECRET
          ciphertext: !!binary fk38IIB+sU8ORGX6jEufVslxHSgFgEgaKB6QAWJYuOZCFDRuejA=
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/TVM_INFO
          ciphertext: !!binary |
              2uRKpvp7oU08Ko30QCsTa/RQg+EihTS4gp86t+Jh8uR0IfNEM+IqMfwryLU4q4QqJatgUL
              PsDw5ULg==
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/REDIS_PASSWORD
          ciphertext: !!binary |
              nryZV67mLI00M71hXttVduFoUTsDfmZOQqrub9HddsK2rpywQksjmIiPKB9Zm8FNqMwrAy
              Or/cWW5Js=
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/APP_MASTER_TOKEN
          ciphertext: !!binary |
              jL7SJ0p/R5W0TFuiAp4ZEc0eBf0igEal9hoROxuV04Rrckcr4Bt9BRYN5iAQ0SVw5b/ZS1
              2H7I+uf5U=
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/PG_PASSWORD
          ciphertext: !!binary |
              B5ETl8DNZ0174CZ0dsBL7johxF4dqWT56OAcGupyegYWaeEz9NASYidkWg9rpKcLXjGlyi
              OpZlqing==
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/DL_CRY_KEY_VAL_ID_cloud_preprod_2
          ciphertext: !!binary |
              1Hv8IA7XfNW3ovVxQL2gPQAaWuXy7dBQqkUF/s/Fmp8I3EhakfV7KfRqh18at4i/k8fuBw
              wOCxQCZhia
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/SETUP_FOLDER_MASTER_TOKEN
          ciphertext: !!binary |
              6bkGdFPcRj4xzuUotTp3Tl26TXFmvBzwPmthteUvCzUnXXA6Ml/6oXc/CRUb0n8LadEtX3
              tP9zJhc5k=
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/SF_PG_PASSWORD
          ciphertext: !!binary |
              yLjXSHr4ry5y2yrKhMPYotbwzqo3KJBBHCUiRJFGkLnhoUB/5u7edUOfuJXORcY+PqsySk
              AMxbQPJ/Q=
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/US_MASTER_TOKEN
          ciphertext: !!binary M1hbZhV/SXzeURNgJpGK1AZR7+VrdvlS0yZaqluD9mOcL7a1ZzjGnAVndtmKyVDt
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/ANALYTICS_CH_PASSWORD
          ciphertext: !!binary |
              AXKRge6ieFYUj94vK+KNilUrTl/1ef7yhNIw6CGFM6AwxKr1imX/M/bBLlwuSEKjyxNDgr
              iOR5Hdef0=
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/TVM_CLIENT_SECRET
          ciphertext: !!binary ejl3IU4mxDiR1Bl7it6zUp5KbPQ0jUpQq5BQeOdk8FclNNKN2E4=
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/YAV_TOKEN
          ciphertext: !!binary |
              2cj5gt+Fdq8i+q2Gi4pvFzIuFrVBaEUig93IlWM8D6MPZmq/tYXRTeusfHJ1kEQN7BG7YK
              As2g==
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/secrets/LOGCH_PASSWORD
          ciphertext: !!binary PKKTzDbFAUl0DxwIv3E4akJO24Wh0prmIBz3qnk66Ypozd4UOgG9GUAS
          mode: 0
          uid: 0
          gid: 0
        - path: /etc/metricsagent/SOLOMON_AUTH
          ciphertext: !!binary |
              jcZq5ZAKGBG49rK2MRY+nMglLucrAmcskuaTReQ9jI1DDvrz45swGUVkSrKX1paBWE4rK4
              n/+Q==
          mode: 0
          uid: 0
          gid: 0
      enc_mode: DETERMINISTIC
      force: false
