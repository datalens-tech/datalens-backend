user www-data;
worker_processes 4;
pid /var/run/nginx.pid;
daemon off;

events {
    worker_connections 768;
}


http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    underscores_in_headers on;

    client_max_body_size 4096M;

    # include /etc/nginx/mime.types;

    server_names_hash_bucket_size 128;
    server_names_hash_max_size 1024;

    keepalive_timeout {{ NGINX_KEEPALIVE_TIMEOUT }};

    # resolver [2a02:6b8::1:1] [2a02:6b8:0:3400::1] ipv6=only;
    large_client_header_buffers 8 32k;
    client_header_buffer_size 8k;

    ########## SSL {

    # Protocols and ciphers
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Sessions cache
    ssl_session_cache    shared:SSL:128m;
    ssl_session_timeout  28h;

    ########## } SSL

    ########## Proxy {

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_buffer_size 8k;

    # tunables
    proxy_connect_timeout 1s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;

    # TODO CONSIDER: Custom pages? At least to do not expose NGINX/OS version
    # error_page 500 /usr/share/nginx/error-pages/500.txt;
    # error_page 502 /usr/share/nginx/error-pages/502.txt;
    # error_page 504 /usr/share/nginx/error-pages/504.txt;

    ########## } Proxy

    gzip off;

    log_format json_combined escape=json '{'
      '"timestamp": "$time_iso8601", '
      '"timestamp_msec": "$msec", '
      '"status": "$status", '
      '"protocol": "$server_protocol", '
      '"method": "$request_method", '
      '"request": "$request_uri", '
      '"referer": "$http_referer", '
      '"user_agent": "$http_user_agent", '
      '"content_length": "$http_content_length", '
      '"response_content_length": "$sent_http_content_length", '
      '"vhost": "$server_name", '
      '"ip": "$remote_addr", '
      '"x_forwarded_for": "$http_x_forwarded_for", '
      '"x_real_ip": "$http_x_real_ip", '
      '"upstream_response_time": "$upstream_response_time", '
      '"body_bytes_sent": "$body_bytes_sent", '
      '"x_request_host": "$sent_http_x_request_host", '
      '"x_request_id": "$sent_http_x_request_id", '
      '"request_time": "$request_time"}';

    access_log /dev/stdout json_combined;
    error_log /dev/stderr;

    {% if NGINX_PROXY_TYPE is not defined or NGINX_PROXY_TYPE in ['', 'http'] %}
    server {
        listen {{ NGINX_LISTEN_PORT }} ssl;
        listen [::]:{{ NGINX_LISTEN_PORT }} ssl;
        ssl_certificate {{ NGINX_CERT_LOCATION }};
        ssl_certificate_key {{ NGINX_CERT_PRIVATE_KEY_LOCATION }};

        location / {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:{{ NGINX_BACKEND_PORT }};
        }
    }
    {% elif NGINX_PROXY_TYPE == 'grpc' %}
    server {
        listen {{ NGINX_LISTEN_PORT }} ssl http2;
        listen [::]:{{ NGINX_LISTEN_PORT }} ssl http2;
        ssl_certificate {{ NGINX_CERT_LOCATION }};
        ssl_certificate_key {{ NGINX_CERT_PRIVATE_KEY_LOCATION }};

        location / {
            proxy_redirect off;
            grpc_pass grpc://127.0.0.1:{{ NGINX_BACKEND_PORT }};
        }
    }
    {% endif %}
}
