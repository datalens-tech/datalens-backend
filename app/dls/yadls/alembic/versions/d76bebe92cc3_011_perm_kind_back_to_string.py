"""011_perm_kind_back_to_string

Revision ID: d76bebe92cc3
Revises: 2b50f2c5a5f7
Create Date: 2018-11-20 17:30:27.081556

"""

from __future__ import annotations

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'd76bebe92cc3'
down_revision = '2b50f2c5a5f7'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # op.alter_column('dls_grant', 'perm_kind',
    #            existing_type=postgresql.JSONB(astext_type=sa.Text()),
    #            type_=sa.String(),
    #            existing_nullable=False)

    # https://stackoverflow.com/a/31757242
    op.execute("""ALTER TABLE dls_grant ALTER COLUMN perm_kind TYPE VARCHAR USING perm_kind #>> '{}' """)

    op.create_index(op.f('ix_dls_grant_perm_kind'), 'dls_grant', ['perm_kind'], unique=False)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_dls_grant_perm_kind'), table_name='dls_grant')
    # op.alter_column('dls_grant', 'perm_kind',
    #            existing_type=sa.String(),
    #            type_=postgresql.JSONB(astext_type=sa.Text()),
    #            existing_nullable=False)
    op.execute('ALTER TABLE dls_grant ALTER COLUMN perm_kind TYPE JSONB USING perm_kind::jsonb')
    # ### end Alembic commands ###
